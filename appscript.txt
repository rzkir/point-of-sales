/**
 * Google Apps Script untuk Authentication dengan Google Sheets
 * 
 * INSTRUKSI SETUP:
 * 1. Buat Google Spreadsheet baru di https://docs.google.com/spreadsheets
 * 2. Buka Extensions > Apps Script di spreadsheet tersebut
 * 3. Paste kode ini ke editor Apps Script
 * 4. PENTING: Pastikan SPREADSHEET_ID = null (baris 31) untuk menggunakan spreadsheet aktif
 * 5. Klik Save (Ctrl+S atau Cmd+S)
 * 6. Klik Deploy > Manage deployments
 * 7. Jika sudah ada deployment:
 *    - Klik Edit (icon pensil)
 *    - Klik Deploy (untuk update dengan kode baru)
 * 8. Jika belum ada deployment:
 *    - Klik New deployment
 *    - Pilih Select type > Web app
 *    - Set konfigurasi:
 *      * Execute as: Me
 *      * Who has access: Anyone (PENTING!)
 *    - Klik Deploy
 * 9. Copy Web App URL yang muncul
 * 10. Paste URL tersebut ke file .env.local sebagai APPS_SCRIPT_URL
 * 
 * PENTING: Setiap kali update kode, HARUS update deployment juga!
 */

// ⚠️ PENTING: Ganti dengan Spreadsheet ID Anda!
// Cara mendapatkan Spreadsheet ID:
// 1. Buka spreadsheet di browser
// 2. Lihat URL di address bar
// 3. Copy bagian ID yang ada di antara /d/ dan /edit
// Contoh: https://docs.google.com/spreadsheets/d/1abc123xyz/edit
//         Spreadsheet ID = 1abc123xyz
// ⚠️ PENTING: Pilih salah satu metode di bawah ini!
// 
// METODE 1 (RECOMMENDED): Jika Apps Script dibuat dari Extensions > Apps Script di spreadsheet
// Biarkan SPREADSHEET_ID null, kode akan otomatis menggunakan spreadsheet aktif
const SPREADSHEET_ID = null; // Gunakan null untuk metode 1

// METODE 2: Jika Apps Script dibuat terpisah (standalone)
// Uncomment baris di bawah dan isi dengan Spreadsheet ID Anda:
// const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';
// Cara mendapatkan Spreadsheet ID dari URL:
// https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit

const SHEET_NAME = 'Users';

/**
 * Mendapatkan spreadsheet
 */
function getSpreadsheet() {
  // Jika SPREADSHEET_ID null atau kosong, gunakan spreadsheet aktif
  if (!SPREADSHEET_ID) {
    try {
      return SpreadsheetApp.getActiveSpreadsheet();
    } catch (error) {
      throw new Error('Tidak dapat mengakses spreadsheet aktif. Pastikan Apps Script dibuat dari Extensions > Apps Script di spreadsheet, atau set SPREADSHEET_ID dengan benar.');
    }
  }
  
  // Jika SPREADSHEET_ID di-set, gunakan openById
  try {
    return SpreadsheetApp.openById(SPREADSHEET_ID);
  } catch (error) {
    throw new Error('Spreadsheet tidak ditemukan atau tidak dapat diakses. Pastikan Spreadsheet ID benar dan Anda memiliki akses ke spreadsheet tersebut. Error: ' + error.toString());
  }
}

/**
 * Mendapatkan sheet Users
 */
function getUsersSheet() {
  const ss = getSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAME);
  
  // Jika sheet belum ada, buat sheet baru
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    // Set header
    sheet.getRange(1, 1, 1, 8).setValues([[
      'id', 'email', 'name', 'password', 'roleType', 'branchId', 'createdAt', 'updatedAt'
    ]]);
    // Format header
    sheet.getRange(1, 1, 1, 8).setFontWeight('bold');
    sheet.getRange(1, 1, 1, 8).setBackground('#4285f4');
    sheet.getRange(1, 1, 1, 8).setFontColor('#ffffff');
  }
  
  return sheet;
}

/**
 * Generate unique ID
 */
function generateId() {
  return Utilities.getUuid();
}

/**
 * Hash password sederhana (untuk production, gunakan library yang lebih aman)
 */
function hashPassword(password) {
  const rawHash = Utilities.computeDigest(
    Utilities.DigestAlgorithm.SHA_256,
    password,
    Utilities.Charset.UTF_8
  );
  return rawHash.map(function(byte) {
    return ('0' + (byte & 0xFF).toString(16)).slice(-2);
  }).join('');
}

/**
 * Verifikasi password
 */
function verifyPassword(password, hashedPassword) {
  const hashedInput = hashPassword(password);
  return hashedInput === hashedPassword;
}

/**
 * Cari user berdasarkan email
 */
function findUserByEmail(email) {
  const sheet = getUsersSheet();
  const data = sheet.getDataRange().getValues();
  
  // Skip header
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] === email) { // email di kolom 1 (index 1)
      return {
        id: data[i][0],
        email: data[i][1],
        name: data[i][2],
        password: data[i][3],
        roleType: data[i][4],
        branchId: data[i][5],
        createdAt: data[i][6],
        updatedAt: data[i][7]
      };
    }
  }
  return null;
}

/**
 * Handler untuk doPost - menerima request dari Next.js
 */
function doPost(e) {
  try {
    const requestData = JSON.parse(e.postData.contents);
    const action = requestData.action;
    
    let response;
    
    switch(action) {
      case 'register':
        response = handleRegister(requestData);
        break;
      case 'login':
        response = handleLogin(requestData);
        break;
      default:
        response = {
          success: false,
          message: 'Invalid action'
        };
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Handler untuk doGet - untuk testing
 */
function doGet(e) {
  return ContentService
    .createTextOutput(JSON.stringify({
      success: true,
      message: 'Google Apps Script API is running',
      timestamp: new Date().toISOString()
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Handle register
 */
function handleRegister(data) {
  const { email, name, password, roleType = 'karyawan', branchId = '' } = data;
  
  // Validasi
  if (!email || !name || !password) {
    return {
      success: false,
      message: 'Email, name, and password are required'
    };
  }
  
  // Validasi email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return {
      success: false,
      message: 'Invalid email format'
    };
  }
  
  // Validasi password length
  if (password.length < 8) {
    return {
      success: false,
      message: 'Password must be at least 8 characters'
    };
  }
  
  // Cek apakah email sudah terdaftar
  const existingUser = findUserByEmail(email);
  if (existingUser) {
    return {
      success: false,
      message: 'Email already registered'
    };
  }
  
  // Hash password
  const hashedPassword = hashPassword(password);
  
  // Generate ID dan timestamp
  const id = generateId();
  const now = new Date().toISOString();
  
  // Simpan ke sheet
  const sheet = getUsersSheet();
  sheet.appendRow([
    id,
    email,
    name,
    hashedPassword,
    roleType,
    branchId,
    now,
    now
  ]);
  
  return {
    success: true,
    message: 'Registration successful',
    data: {
      id: id,
      email: email,
      name: name,
      roleType: roleType,
      branchId: branchId
    }
  };
}

/**
 * Handle login
 */
function handleLogin(data) {
  const { email, password } = data;
  
  // Validasi
  if (!email || !password) {
    return {
      success: false,
      message: 'Email and password are required'
    };
  }
  
  // Cari user
  const user = findUserByEmail(email);
  if (!user) {
    return {
      success: false,
      message: 'Invalid email or password'
    };
  }
  
  // Verifikasi password
  if (!verifyPassword(password, user.password)) {
    return {
      success: false,
      message: 'Invalid email or password'
    };
  }
  
  // Update updatedAt
  const sheet = getUsersSheet();
  const dataRange = sheet.getDataRange().getValues();
  for (let i = 1; i < dataRange.length; i++) {
    if (dataRange[i][1] === email) {
      sheet.getRange(i + 1, 8).setValue(new Date().toISOString());
      break;
    }
  }
  
  // Return user data (tanpa password)
  return {
    success: true,
    message: 'Login successful',
    data: {
      id: user.id,
      email: user.email,
      name: user.name,
      roleType: user.roleType,
      branchId: user.branchId
    }
  };
}
