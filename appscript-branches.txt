/**
 * Google Apps Script untuk Management Branches dengan Google Sheets
 * 
 * INSTRUKSI SETUP:
 * 1. Buka Google Spreadsheet yang sama dengan Users sheet
 * 2. Buka Extensions > Apps Script di spreadsheet tersebut
 * 3. Paste kode ini ke editor Apps Script (atau tambahkan ke file yang sama dengan Users script)
 * 4. PENTING: Pastikan SPREADSHEET_ID = null (baris 31) untuk menggunakan spreadsheet aktif
 * 5. Klik Save (Ctrl+S atau Cmd+S)
 * 6. Klik Deploy > Manage deployments
 * 7. Jika sudah ada deployment:
 *    - Klik Edit (icon pensil)
 *    - Klik Deploy (untuk update dengan kode baru)
 * 8. Jika belum ada deployment:
 *    - Klik New deployment
 *    - Pilih Select type > Web app
 *    - Set konfigurasi:
 *      * Execute as: Me
 *      * Who has access: Anyone (PENTING!)
 *    - Klik Deploy
 * 9. Copy Web App URL yang muncul
 * 10. Paste URL tersebut ke file .env.local sebagai APPS_SCRIPT_BRANCHES_URL
 * 
 * PENTING: Setiap kali update kode, HARUS update deployment juga!
 * 
 * ACTIONS YANG DIDUKUNG:
 * - create: Membuat branch baru
 * - list: Mendapatkan semua branches
 * - get: Mendapatkan branch berdasarkan ID
 * - update: Update branch
 * - delete: Hapus branch
 */

// ⚠️ PENTING: Ganti dengan Spreadsheet ID Anda!
// Cara mendapatkan Spreadsheet ID:
// 1. Buka spreadsheet di browser
// 2. Lihat URL di address bar
// 3. Copy bagian ID yang ada di antara /d/ dan /edit
// Contoh: https://docs.google.com/spreadsheets/d/1abc123xyz/edit
//         Spreadsheet ID = 1abc123xyz
// ⚠️ PENTING: Pilih salah satu metode di bawah ini!
// 
// METODE 1 (RECOMMENDED): Jika Apps Script dibuat dari Extensions > Apps Script di spreadsheet
// Biarkan SPREADSHEET_ID null, kode akan otomatis menggunakan spreadsheet aktif
const SPREADSHEET_ID = null; // Gunakan null untuk metode 1

// METODE 2: Jika Apps Script dibuat terpisah (standalone)
// Uncomment baris di bawah dan isi dengan Spreadsheet ID Anda:
// const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';
// Cara mendapatkan Spreadsheet ID dari URL:
// https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit

const BRANCHES_SHEET_NAME = 'Branches';

/**
 * Mendapatkan spreadsheet
 */
function getSpreadsheet() {
  // Jika SPREADSHEET_ID null atau kosong, gunakan spreadsheet aktif
  if (!SPREADSHEET_ID) {
    try {
      return SpreadsheetApp.getActiveSpreadsheet();
    } catch (error) {
      throw new Error('Tidak dapat mengakses spreadsheet aktif. Pastikan Apps Script dibuat dari Extensions > Apps Script di spreadsheet, atau set SPREADSHEET_ID dengan benar.');
    }
  }
  
  // Jika SPREADSHEET_ID di-set, gunakan openById
  try {
    return SpreadsheetApp.openById(SPREADSHEET_ID);
  } catch (error) {
    throw new Error('Spreadsheet tidak ditemukan atau tidak dapat diakses. Pastikan Spreadsheet ID benar dan Anda memiliki akses ke spreadsheet tersebut. Error: ' + error.toString());
  }
}

/**
 * Mendapatkan sheet Branches
 */
function getBranchesSheet() {
  const ss = getSpreadsheet();
  let sheet = ss.getSheetByName(BRANCHES_SHEET_NAME);
  
  // Jika sheet belum ada, buat sheet baru
  if (!sheet) {
    sheet = ss.insertSheet(BRANCHES_SHEET_NAME);
    // Set header
    sheet.getRange(1, 1, 1, 5).setValues([[
      'id', 'name', 'address', 'createdAt', 'updatedAt'
    ]]);
    // Format header
    sheet.getRange(1, 1, 1, 5).setFontWeight('bold');
    sheet.getRange(1, 1, 1, 5).setBackground('#4285f4');
    sheet.getRange(1, 1, 1, 5).setFontColor('#ffffff');
  }
  
  return sheet;
}

/**
 * Generate unique ID
 */
function generateId() {
  return Utilities.getUuid();
}

/**
 * Cari branch berdasarkan ID
 */
function findBranchById(id) {
  const sheet = getBranchesSheet();
  const data = sheet.getDataRange().getValues();
  
  // Skip header
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === id) { // id di kolom 0 (index 0)
      return {
        id: data[i][0],
        name: data[i][1],
        address: data[i][2],
        createdAt: data[i][3],
        updatedAt: data[i][4]
      };
    }
  }
  return null;
}

/**
 * Cari branch berdasarkan name
 */
function findBranchByName(name) {
  const sheet = getBranchesSheet();
  const data = sheet.getDataRange().getValues();
  
  // Skip header
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] === name) { // name di kolom 1 (index 1)
      return {
        id: data[i][0],
        name: data[i][1],
        address: data[i][2],
        createdAt: data[i][3],
        updatedAt: data[i][4]
      };
    }
  }
  return null;
}

/**
 * Handler untuk doPost - menerima request dari Next.js
 */
function doPost(e) {
  try {
    const requestData = JSON.parse(e.postData.contents);
    const action = requestData.action;
    
    let response;
    
    switch(action) {
      case 'create':
        response = handleCreateBranch(requestData);
        break;
      case 'list':
        response = handleListBranches(requestData);
        break;
      case 'get':
        response = handleGetBranch(requestData);
        break;
      case 'update':
        response = handleUpdateBranch(requestData);
        break;
      case 'delete':
        response = handleDeleteBranch(requestData);
        break;
      default:
        response = {
          success: false,
          message: 'Invalid action. Supported actions: create, list, get, update, delete'
        };
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Handler untuk doGet - untuk testing
 */
function doGet(e) {
  return ContentService
    .createTextOutput(JSON.stringify({
      success: true,
      message: 'Google Apps Script Branches API is running',
      timestamp: new Date().toISOString()
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Handle create branch
 */
function handleCreateBranch(data) {
  const { name, address = '' } = data;
  
  // Validasi
  if (!name || String(name).trim() === '') {
    return {
      success: false,
      message: 'Branch name is required'
    };
  }
  
  // Cek apakah name sudah ada
  const existingBranch = findBranchByName(String(name).trim());
  if (existingBranch) {
    return {
      success: false,
      message: 'Branch name already exists'
    };
  }
  
  // Generate ID dan timestamp
  const id = generateId();
  const now = new Date().toISOString();
  
  // Simpan ke sheet
  const sheet = getBranchesSheet();
  sheet.appendRow([
    id,
    String(name).trim(),
    String(address).trim(),
    now,
    now
  ]);
  
  return {
    success: true,
    message: 'Branch created successfully',
    data: {
      id: id,
      name: String(name).trim(),
      address: String(address).trim(),
      createdAt: now,
      updatedAt: now
    }
  };
}

/**
 * Handle list branches
 */
function handleListBranches(data) {
  const sheet = getBranchesSheet();
  const dataRange = sheet.getDataRange().getValues();
  
  // Skip header
  const branches = [];
  for (let i = 1; i < dataRange.length; i++) {
    branches.push({
      id: dataRange[i][0],
      name: dataRange[i][1],
      address: dataRange[i][2],
      createdAt: dataRange[i][3],
      updatedAt: dataRange[i][4]
    });
  }
  
  return {
    success: true,
    message: 'Branches retrieved successfully',
    data: branches
  };
}

/**
 * Handle get branch by ID
 */
function handleGetBranch(data) {
  const { id } = data;
  
  if (!id) {
    return {
      success: false,
      message: 'Branch ID is required'
    };
  }
  
  const branch = findBranchById(id);
  
  if (!branch) {
    return {
      success: false,
      message: 'Branch not found'
    };
  }
  
  return {
    success: true,
    message: 'Branch retrieved successfully',
    data: branch
  };
}

/**
 * Handle update branch
 */
function handleUpdateBranch(data) {
  const { id, name, address } = data;
  
  if (!id) {
    return {
      success: false,
      message: 'Branch ID is required'
    };
  }
  
  const branch = findBranchById(id);
  
  if (!branch) {
    return {
      success: false,
      message: 'Branch not found'
    };
  }
  
  // Validasi name jika diubah
  if (name !== undefined && name !== null) {
    const nameStr = String(name).trim();
    if (nameStr === '') {
      return {
        success: false,
        message: 'Branch name cannot be empty'
      };
    }
    
    // Cek apakah name sudah digunakan oleh branch lain
    const existingBranch = findBranchByName(nameStr);
    if (existingBranch && existingBranch.id !== id) {
      return {
        success: false,
        message: 'Branch name already exists'
      };
    }
  }
  
  // Update data
  const sheet = getBranchesSheet();
  const dataRange = sheet.getDataRange().getValues();
  
  for (let i = 1; i < dataRange.length; i++) {
    if (dataRange[i][0] === id) {
      const row = i + 1; // +1 karena index sheet dimulai dari 1
      const now = new Date().toISOString();
      
      // Update hanya field yang diubah
      if (name !== undefined && name !== null) {
        sheet.getRange(row, 2).setValue(String(name).trim());
      }
      if (address !== undefined && address !== null) {
        sheet.getRange(row, 3).setValue(String(address).trim());
      }
      
      // Update updatedAt
      sheet.getRange(row, 5).setValue(now);
      
      // Ambil data terbaru
      const updatedBranch = findBranchById(id);
      
      return {
        success: true,
        message: 'Branch updated successfully',
        data: updatedBranch
      };
    }
  }
  
  return {
    success: false,
    message: 'Branch not found'
  };
}

/**
 * Handle delete branch
 */
function handleDeleteBranch(data) {
  const { id } = data;
  
  if (!id) {
    return {
      success: false,
      message: 'Branch ID is required'
    };
  }
  
  const branch = findBranchById(id);
  
  if (!branch) {
    return {
      success: false,
      message: 'Branch not found'
    };
  }
  
  // Hapus dari sheet
  const sheet = getBranchesSheet();
  const dataRange = sheet.getDataRange().getValues();
  
  for (let i = 1; i < dataRange.length; i++) {
    if (dataRange[i][0] === id) {
      sheet.deleteRow(i + 1); // +1 karena index sheet dimulai dari 1
      
      return {
        success: true,
        message: 'Branch deleted successfully'
      };
    }
  }
  
  return {
    success: false,
    message: 'Branch not found'
  };
}
